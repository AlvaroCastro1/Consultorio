<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="..//CSS/EstudiosStyles.css">
    <link rel="stylesheet" href="..//CSS/barraNav.css">
   
</head>
<body>
    <div id="alerta">
        <div aria-live="polite" aria-atomic="true" class="bg-body-secondary position-relative bd-example-toasts rounded-3">
            <div class="toast-container p-3 top-0 end-0" id="toastPlacement">
                <div class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                      <div class="toast-body">
                      </div>
                      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                  </div>
            </div>
        </div>              
    </div>
    <nav class="navbar navbar-expand-lg navbar-light bg-primary-custom">
        <div class="container">
            <a class="navbar-brand texto-gris-claro" href="..//Expediente/expediente.html" style="font-size: 20px; font-weight: bold; ">Expediente Médico</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link texto-gris-claro" href="..//Vacunas/vacunas.html" onclick="abrirPagina('vacunas')">Vacunas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link texto-blanco-activo" href="..//Estudios/estudios.html" onclick="abrirPagina('estudios')">Estudios</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link texto-gris-claro" href="..//Alergias/alergias.html" onclick="abrirPagina('alergias')">Alergias</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link texto-gris-claro" href="../Antecedentes/antecedentes.html" onclick="abrirPagina('antecedentes')">Antecedentes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link texto-gris-claro" href="..//Signos/Signos.html" onclick="abrirPagina('signos')">Signos Vitales</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link texto-gris-claro" href="..//Tratamiento/Tratamiento.html" onclick="abrirPagina('tratamiento')">Tratamiento</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link texto-gris-claro" href="..//Procedimiento/procedimiento.html" onclick="abrirPagina('procedimiento')">Procedimiento</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link texto-gris-claro" href="..//Control/control.html" onclick="abrirPagina('control')">Control de Crecimiento</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container2 mt-5">
        <h1 class="titulo-inicio mb-4">Estudios</h1>
            <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="Buscar por tipo" id="input-busqueda" name="input-busqueda">
                <button class="btn btn-outline-secondary" type="button" onclick="buscar()">Buscar</button>
            </div>
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalAgregar">Agregar</button>

        <!--Modal-->
        <div class="modal fade" id="modalAgregar" tabindex="-1" aria-labelledby="modalAgregarLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalAgregarLabel">Agregar Registro de Estudios</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="POST" action="../Estudios/insertarEstudios.php" id="registroEstudio">
                            <!-- Aquí van los campos para agregar un nuevo registro -->
                            <input type="text" class="form-control mb-3" id="nombreEstudio" name="nombreEstudio" placeholder="Nombre del Estudio" maxlength="45">
                            <input type="text" class="form-control mb-3"  id="tipoEstudio" name="tipoEstudio" placeholder="Tipo del Estudio" maxlength="50">
                            <input type="date" class="form-control mb-3" id="fechaEstudio" name="fechaEstudio">
                            <textarea class="form-control mb-3" id="descripcionEstudio" name="descripcionEstudio"  placeholder="Descripción del Estudio" maxlength="100" ></textarea>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="verResultado()">Agregar Resultados</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-primary" onclick="insertaEstudio()" id="btnAceptar">Aceptar</button>
                        <button type="submit" class="btn btn-primary d-none"
                        onclick="actualizaEstudio()" id="btnActualizar">Actualizar</button>
                    </div>
                    
                </div>
            </div>
        </div>


        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="tabla-estudios">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Resultado</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <td contenteditable="false">Ejemplo de estudio</td>
                        <td>
                             <button type="button" class="btn btn-primary" onclick="verResultado(this)">Ver Resultados</button>
                        </td>
                        <td contenteditable="false">2024-04-16</td>
                        <td>
                            <button type="button" class="btn btn-danger me-2" onclick="eliminarEstudio(this)">Eliminar</button>
                            <button type="button" class="btn btn-primary" onclick="obtenerEstudioid(this)">Modificar</button>
                        </td>
                    </tr>
                    
                </tbody>
            </table>
        </div>
        <div class="espacio-final"></div>
    </div>
    <footer>
        <div class="container3">
            <p>Pie de página</p>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var idExpediente = 1;
        var estudio = null;

        document.addEventListener("DOMContentLoaded", function() {
            buscar();
        });

        function setIdExpediente(idExpediente){
            this.idExpediente = idExpediente;
        }

        function mostrarAlerta(mensaje, tipo){
            //asignar texto al toast
            document.querySelector('.toast-body').innerHTML = mensaje;

            let toast = document.querySelector('.toast');
            toast.classList.remove('text-bg-success');
            toast.classList.remove('text-bg-danger');
            toast.classList.remove('text-bg-warning');
            toast.classList.add(tipo);
            // mostrar alerta
            let alerta = new bootstrap.Toast(toast);
            alerta.show();
        }

        function validarRegistro(){
            let nombre=document.getElementById('nombreEstudio');
            if (nombre.value === '') {
                mostrarAlerta('Por favor, ingrese un nombre de estudio', 'text-bg-warning');
                return false;
            }

            let tipo=document.getElementById('tipoEstudio');
            if(tipo.value === ''){
                mostrarAlerta('Por favor, ingrese un tipo de estudio' , 'text-bg-warning');
                return false;
            }

            let descripcion=document.getElementById('descripcionEstudio');
            if(descripcion.value === ''){
                mostrarAlerta('Por favor, ingrese una descripción', 'text-bg-warning');
                return false;
            }

            return true;
        }

        function insertaEstudio(){
            if(validarRegistro()){
                let nombreEstudio=document.getElementById('nombreEstudio').value;
                let tipoEstudio=document.getElementById('tipoEstudio').value;
                let descripcionEstudio=document.getElementById('descripcionEstudio').value;
                let fechaEstudio=document.getElementById('fechaEstudio').value;
                // URL a la que enviar la petición POST
                const url = './insertarEstudios.php';

                // Crear un objeto FormData
                const formData = new FormData();
                formData.append('nombreEstudio', nombreEstudio);
                formData.append('tipoEstudio', tipoEstudio);
                formData.append('descripcionEstudio', descripcionEstudio);
                formData.append('fechaEstudio', fechaEstudio);
                formData.append('idExpediente', this.idExpediente);

                // Configuración de la petición
                const configuracion = {
                    method: 'POST',
                    body: formData
                };

                // Enviamos la petición
                let text = '';
                fetch(url, configuracion)
                .then(response => Promise.all([response.status, response.text()]))
                .then(([status, text]) => {
                    console.log(status);
                    console.log(text);
                    
                    if(status !== 200){
                        mostrarAlerta(text,'text-bg-danger');
                        
                    } else {
                        mostrarAlerta(text, 'text-bg-success');
                    }
                    limpiarModal();    
                });
                
                cambiarModal();
                location.reload();
            }
        }

        function verResultado() {
            window.location.href = "..//Resultados/resultados.html";
        }

        function buscar() {
            // Obtenemos el valor del input de búsqueda y eliminamos los espacios en blanco al inicio y al final
            let tipoEstudio = document.getElementById("input-busqueda").value.trim();

            // Definimos la URL a la que enviaremos la solicitud
            const url = './mostrarEstudios.php';

            // Creamos un objeto FormData y agregamos el valor del input de búsqueda
            let formData = new FormData();
            formData.append('tipoEstudio', tipoEstudio);
            formData.append('idExpediente', this.idExpediente);

            // Realizamos la solicitud POST al servidor utilizando fetch
            fetch(url, {
                method: "POST",
                body: formData
            })
            // Manejamos la respuesta del servidor
            .then(response => {
                // Verificamos si la respuesta fue exitosa
                if (!response.ok) {
                    throw new Error('Ocurrió un problema con la solicitud.');
                }
                // Convertimos la respuesta a formato JSON
                return response.json();
            })
            // Manejamos los datos obtenidos del servidor
            .then(data => {
                // Obtenemos el cuerpo de la tabla
                let tableBody = document.getElementById("tabla-estudios").querySelector("tbody");

                // Verificamos si se pudo encontrar el cuerpo de la tabla
                if (!tableBody) {
                    throw new Error('No se pudo encontrar el cuerpo de la tabla.');
                }

                // Limpiamos el contenido actual del cuerpo de la tabla
                tableBody.innerHTML = '';

                // Iteramos sobre los datos obtenidos y creamos filas en la tabla para cada conjunto de datos
                data.forEach(rowData => {
                    let row = document.createElement('tr');
                    // Insertamos los datos en las celdas de la fila
                    row.innerHTML = `
                        <td>${rowData.nombreEstudio}</td>
                        <td>
                            <button type="button" class="btn btn-primary" onclick="verResultado(this)">Ver Resultados</button>
                        </td>
                        <td>${rowData.fechaEstudio}</td>
                        <td>
                            <button type="button" class="btn btn-danger me-2" onclick="eliminarEstudio(${rowData.idEstudios})">Eliminar</button>
                            <button type="button" class="btn btn-primary" onclick="obtenerEstudioid(${rowData.idEstudios})">Modificar</button>
                        </td>
                    `;
                    // Agregamos la fila al cuerpo de la tabla
                    tableBody.appendChild(row);
                });
            })
            // Manejamos errores que puedan ocurrir durante la solicitud
            .catch(error => {
                console.error('Error al realizar la solicitud:', error);
            });
        }

        function obtenerEstudioid(idEstudio) {
            const url = './mostrarEstudios.php';

            // Creamos un objeto FormData y agregamos el valor del input de búsqueda
            let formData = new FormData();
            formData.append('idEstudios', idEstudio);
            formData.append('idExpediente', this.idExpediente);

            // Realizamos la solicitud POST al servidor utilizando fetch
            fetch(url, {
                method: "POST",
                body: formData
            })
            // Manejamos la respuesta del servidor
            .then(response => {
                // Verificamos si la respuesta fue exitosa
                if (!response.ok) {
                    throw new Error('Ocurrió un problema con la solicitud.');
                }
                // Convertimos la respuesta a formato JSON
                return response.json();
            })
            // Manejamos los datos obtenidos del servidor
            .then(data => {
                console.log(data);
                if(data.length){
                    document.getElementById('btnActualizar').classList.remove('d-none');
                    document.getElementById('btnActualizar').classList.add('d-block');
                    document.getElementById('btnAceptar').classList.remove('d-block');
                    document.getElementById('btnAceptar').classList.add('d-none');
                    this.estudio=data[0];
                    // Obtener los datos del formulario
                    document.getElementById('nombreEstudio').value = this.estudio.nombreEstudio;
                    document.getElementById('tipoEstudio').value = this.estudio.tipoEstudio;
                    document.getElementById('descripcionEstudio').value = this.estudio.descripcionEstudio;
                    document.getElementById('fechaEstudio').value = this.estudio.fechaEstudio;
                    console.log(estudio.fechaEstudio);
                    cambiarModal();
                }
            })
            // Manejamos errores que puedan ocurrir durante la solicitud
            .catch(error => {
                console.error('Error al realizar la solicitud:', error);
            });
        }

        function eliminarEstudio(idEstudio){
            const url = './eliminarEstudio.php';

            const data = {
                idEstudio: idEstudio,
                idExpediente: this.idExpediente
            };

            // Configuración de la petición
            const configuracion = {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data) // Convertir el objeto en una cadena JSON
            };

            // Enviamos la petición
            let text = '';
            fetch(url, configuracion)
            .then(response => Promise.all([response.status, response.text()]))
            .then(([status, text]) => {
                if(status !== 200){
                    mostrarAlerta(text,'text-bg-danger');
                } else {
                    mostrarAlerta(text, 'text-bg-success');
                }
            });
            recargarPagina(3000);
        }

        function recargarPagina(milisegundos){
            // Recargar la página
            setTimeout(function() {
                location.reload();
            }, milisegundos); 

        }

        function cambiarModal() {
            const modalElement = document.getElementById('modalAgregar');
            const modal = new bootstrap.Modal(modalElement);
            modal.toggle();
            // Agregar el siguiente código para cerrar el modal después de abrirlo
            setTimeout(() => {
                modal.hide();
            },7000); // Cambia el tiempo según sea necesario
        }



        function limpiarModal(){
            // Limpiar los campos del modal
            document.getElementById('nombreEstudio').value = '';
            document.getElementById('tipoEstudio').value='';
            document.getElementById('descripcionEstudio').value='';
            document.getElementById('fechaEstudio').value='';
        }

        function actualizaEstudio(){
            if(validarRegistro()){
                let nombreEstudio=document.getElementById('nombreEstudio').value;
                let tipoEstudio=document.getElementById('tipoEstudio').value;
                let descripcionEstudio=document.getElementById('descripcionEstudio').value;
                let fechaEstudio=document.getElementById('fechaEstudio').value;
                // URL a la que enviar la petición POST
                const url = './modificarEstudio.php';

                // Crear un objeto FormData
                const formData = new FormData();
                formData.append('idEstudio', this.estudio.idEstudios);
                formData.append('nombreEstudio', nombreEstudio);
                formData.append('tipoEstudio', tipoEstudio);
                formData.append('descripcionEstudio', descripcionEstudio);
                formData.append('fechaEstudio', fechaEstudio);

                // Configuración de la petición
                const configuracion = {
                    method: 'POST',
                    body: formData
                };

                // Enviamos la petición
                let text = '';
                fetch(url, configuracion)
                .then(response => Promise.all([response.status, response.text()]))
                .then(([status, text]) => {
                    if(status !== 200){
                        mostrarAlerta(text,'text-bg-danger');
                    } else {
                        limpiarModal(); 
                        cambiarModal();
                        document.getElementById('btnActualizar').classList.remove('d-block');
                        document.getElementById('btnActualizar').classList.add('d-none');
                        document.getElementById('btnAceptar').classList.remove('d-none');
                        document.getElementById('btnAceptar').classList.add('d-block');
                        mostrarAlerta(text, 'text-bg-success');
                        // Recargar la página después de actualizar exitosamente
                        location.reload();
                    }
                });
            }
            
        }
    </script>
</body>
</html>
